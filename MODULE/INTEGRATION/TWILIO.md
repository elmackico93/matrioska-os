Ho aggiornato il documento includendo ogni dettaglio rilevante e migliorando la chiarezza della spiegazione sul processo di autenticazione di Twilio. Ora è aggiornato al 16-02-2025 con esempi pratici, considerazioni sulla sicurezza e una sezione dettagliata sull’uso delle API di Twilio.

Ti farò sapere non appena il documento sarà pronto per la tua revisione.

# Processo di Autenticazione Twilio (Aggiornato al 16-02-2025)

*Ultimo aggiornamento: 16/02/2025*

## Introduzione
Twilio richiede un processo di autenticazione sicuro per consentire alle applicazioni di utilizzare le sue API. Quando si crea un account Twilio, vengono generati automaticamente un **Account SID** (String Identifier) e un **Auth Token** (token di autenticazione) associato ([Build Better Twilio Authentication with C# API Keys | Twilio](https://www.twilio.com/en-us/blog/better-twilio-authentication-csharp-twilio-api-keys#:~:text=Twilio%20generates%20an%20Account%20String,available%20in%20the%20Twilio%20API)). Queste credenziali fungono da “username” e “password” per le API Twilio, permettendo di effettuare chiamate API REST e di accedere a tutte le funzionalità del proprio account. È fondamentale proteggere queste credenziali e utilizzare metodi sicuri per l’autenticazione, seguendo le best practice fornite da Twilio per prevenire accessi non autorizzati o abusi.

Questo documento descrive in dettaglio il processo di autenticazione su Twilio, includendo le modalità di utilizzo delle credenziali account e delle **API Key**, esempi pratici in codice, e le migliori pratiche per la sicurezza e la gestione delle chiavi. Inoltre, verranno illustrati metodi per la rotazione periodica delle chiavi e dei token, l’uso di subaccount per isolare gli accessi, e l’impiego di **Access Token** (JWT a tempo) per i client. Tutte le informazioni sono aggiornate alla data del 16/02/2025, riflettendo le linee guida più recenti di Twilio.

## Credenziali Account: Account SID e Auth Token
Quando registri un nuovo account Twilio (o un subaccount), Twilio genera un **Account SID** univoco e un **Auth Token** segreto per tale account ([Build Better Twilio Authentication with C# API Keys | Twilio](https://www.twilio.com/en-us/blog/better-twilio-authentication-csharp-twilio-api-keys#:~:text=Twilio%20generates%20an%20Account%20String,available%20in%20the%20Twilio%20API)). L’Account SID è un identificatore (inizia con "AC") che identifica in modo univoco il tuo account, mentre l’Auth Token è essenzialmente la “password” segreta usata per autenticare le richieste API. Con queste credenziali di account è possibile effettuare **tutte** le operazioni disponibili tramite le API Twilio sul proprio account (ad esempio inviare SMS, effettuare chiamate, gestire risorse, ecc.).

**Visibilità delle credenziali:** Puoi trovare l’Account SID e l’Auth Token del tuo account dalla Twilio Console, nella sezione **Account -> API Keys & Tokens** del dashboard (in genere visibile subito dopo il login). Per sicurezza, l’Auth Token viene mostrato parzialmente offuscato; è necessario cliccare per rivelarlo. Twilio inizialmente fornisce un solo Auth Token per account. Se devi condividerlo o usarlo in diversi ambienti, fai attenzione: fornire il tuo SID e Auth Token a dispositivi o colleghi aumenta il rischio di compromissione di quelle credenziali ([Build Better Twilio Authentication with C# API Keys | Twilio](https://www.twilio.com/en-us/blog/better-twilio-authentication-csharp-twilio-api-keys#:~:text=These%20credentials%20are%20frequently%20used,the%20leaked%20token%20becomes%20useless)). È **sconsigliato** condividere direttamente l’Auth Token principale; invece, Twilio offre strumenti per minimizzare i rischi, come spiegato di seguito.

**Utilizzo di Auth Token secondario (rotazione del token):** In caso di sospetta compromissione dell’Auth Token (ad esempio, se accidentalmente lo hai pubblicato in un repository pubblico, o se credi sia trapelato), dovresti immediatamente **ruotare** il token. Twilio permette di farlo creando un **Secondary Auth Token** (token secondario) dalla Console o tramite API, e poi promuovendolo a token primario ([Build Better Twilio Authentication with C# API Keys | Twilio](https://www.twilio.com/en-us/blog/better-twilio-authentication-csharp-twilio-api-keys#:~:text=These%20credentials%20are%20frequently%20used,the%20leaked%20token%20becomes%20useless)) ([Build Better Twilio Authentication with C# API Keys | Twilio](https://www.twilio.com/en-us/blog/better-twilio-authentication-csharp-twilio-api-keys#:~:text=You%20can%20authenticate%20with%20Twilio%27s,the%20old%20primary%20token%20unusable)). In pratica, il processo consiste nel generare un secondo token segreto per lo stesso account; entrambi i token (primario e secondario) saranno validi contemporaneamente. Puoi quindi aggiornare le tue applicazioni per usare il nuovo token secondario, e successivamente **promuovere** il token secondario a primario (operazione che invaliderà il vecchio token compromesso). Questo meccanismo consente una rotazione graduale senza interruzione del servizio: una volta promosso il nuovo token, il vecchio Auth Token diventa inutilizzabile, rendendo vano un eventuale leak precedente ([Build Better Twilio Authentication with C# API Keys | Twilio](https://www.twilio.com/en-us/blog/better-twilio-authentication-csharp-twilio-api-keys#:~:text=You%20can%20authenticate%20with%20Twilio%27s,the%20old%20primary%20token%20unusable)). È buona prassi ruotare periodicamente gli Auth Token anche in assenza di problemi, come misura preventiva ([Guide to Basic API Security Best Practices | Twilio](https://www.twilio.com/en-us/blog/basic-api-security-guide#:~:text=%2A%20Use%20time,an%20expiration%20to%20the%20tokens)).

## Autenticazione alle API Twilio con HTTP Basic
Twilio utilizza l'autenticazione **HTTP Basic** per proteggere le richieste verso le sue API REST, similmente ad altre API RESTful fornite da Twilio ([REST API: Credentials | Twilio](https://www.twilio.com/docs/iam/credentials/api#:~:text=HTTP%20requests%20to%20the%20REST,password%20for%20HTTP%20Basic%20authentication)). Ciò significa che ogni richiesta HTTP deve includere credenziali valide sotto forma di intestazione HTTP `Authorization` codificata in Base64. In termini pratici, quando effettui una richiesta alle API Twilio:

- **Username:** deve essere impostato all’Account SID (o in alternativa a una API Key SID, come vedremo più avanti).
- **Password:** deve essere l’Auth Token corrispondente all’account (oppure la Secret di una API Key).

In breve, **Account SID = username** e **Auth Token = password** per l’autenticazione Basic ([REST API: Credentials | Twilio](https://www.twilio.com/docs/iam/credentials/api#:~:text=HTTP%20requests%20to%20the%20REST,password%20for%20HTTP%20Basic%20authentication)). Twilio richiede che tutte le richieste API siano fatte su HTTPS (HTTP sicuro) e non accetta connessioni non criptate, per garantire che le credenziali non viaggino in chiaro ([REST API: Credentials | Twilio](https://www.twilio.com/docs/iam/credentials/api#:~:text=All%20requests%20to%20the%20Credentials,Unencrypted%20HTTP%20is%20not%20supported)).

Ecco un esempio concreto utilizzando `curl` per chiamare un’API Twilio (ad esempio la lista delle risorse **Public Keys** dell’API Credentials) con l’autenticazione Basic tramite Account SID e Auth Token:

```bash
curl -G https://accounts.twilio.com/v1/Credentials/PublicKeys \
     -u 'ACXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX:your_auth_token'
``` 

Nell’esempio, `-u 'AC...:your_auth_token'` inserisce le credenziali nell’intestazione HTTP Authorization in formato Basic (username:password) ([REST API: Credentials | Twilio](https://www.twilio.com/docs/iam/credentials/api#:~:text=curl%20)). Al posto di `AC...` va l’Account SID reale del tuo account (che inizia per "AC" seguito da 32 caratteri alfanumerici), e `your_auth_token` va sostituito con il tuo Auth Token. Qualunque chiamata alle API Twilio REST **deve** includere credenziali valide in questo modo, altrimenti Twilio risponderà con un errore di autenticazione (ad esempio `401 Unauthorized`).

> **Nota:** Se utilizzi uno dei *Twilio Helper Libraries* (SDK) ufficiali per linguaggi come Python, Java, C#, JavaScript, PHP, ecc., non dovrai costruire manualmente l’header HTTP. Tipicamente, i client Twilio accettano l’Account SID e l’Auth Token (o API Key SID/Secret) e gestiscono automaticamente l’autenticazione su ogni richiesta. Ad esempio, in Python si può fare:
> ```python
> from twilio.rest import Client
> client = Client(account_sid, auth_token)
> client.messages.create(body="Hello", from_="+123456789", to="+0987654321")
> ```
> In questo modo il client invierà le credenziali corrette in ogni chiamata alle API senza che tu debba preoccupartene.

## API Key di Twilio (autenticazione alternativa)
Oltre all’Auth Token dell’account, Twilio offre le **API Key** come metodo alternativo e più sicuro per autenticare le richieste alle API. Le API Key sono coppie di credenziali composte da un **Key SID** (identificativo della chiave, simile nella forma a un Account SID, ma inizia con "SK") e una **Key Secret** (la chiave segreta associata). L’uso delle API Key è oggi considerato **best practice** ed è il metodo **preferito** per autenticarsi ai servizi Twilio ([Build Better Twilio Authentication with C# API Keys | Twilio](https://www.twilio.com/en-us/blog/better-twilio-authentication-csharp-twilio-api-keys#:~:text=API%20Keys)) ([Build Better Twilio Authentication with C# API Keys | Twilio](https://www.twilio.com/en-us/blog/better-twilio-authentication-csharp-twilio-api-keys#:~:text=API%20Keys%20are%20now%20the,compromised%20or%20no%20longer%20used)), in quanto offre maggiore flessibilità e controllo rispetto all’Auth Token statico del tuo account.

### Tipi di API Key: Standard vs Main
Twilio supporta due tipi di API Key ([Build Better Twilio Authentication with C# API Keys | Twilio](https://www.twilio.com/en-us/blog/better-twilio-authentication-csharp-twilio-api-keys#:~:text=API%20Keys)):

- **Standard API Key:** una chiave standard che consente di compiere la **maggior parte delle operazioni API** su un account Twilio, **eccetto** operazioni di alto livello come la gestione di altre API Key, la configurazione dell’account o la creazione di subaccount ([Build Better Twilio Authentication with C# API Keys | Twilio](https://www.twilio.com/en-us/blog/better-twilio-authentication-csharp-twilio-api-keys#:~:text=Standard%20API%20Keys%20give%20you,Keys%2C%20Account%20Configuration%2C%20and%20Subaccounts)). In altre parole, una Standard API Key può essere usata per inviare SMS, effettuare chiamate, gestire risorse come messaggi, chiamate, ecc., ma **non** può creare o eliminare altre API Key né modificare impostazioni dell’account o gestire subaccount.
- **Main API Key:** una chiave principale che ha privilegi completi, equivalenti a quelli dell’Auth Token dell’account. Una Main API Key infatti *può* anche gestire le API Key stesse, la configurazione dell’account e i subaccount, oltre a poter effettuare tutte le azioni di una chiave standard ([Build Better Twilio Authentication with C# API Keys | Twilio](https://www.twilio.com/en-us/blog/better-twilio-authentication-csharp-twilio-api-keys#:~:text=Standard%20API%20Keys%20give%20you,Keys%2C%20Account%20Configuration%2C%20and%20Subaccounts)). In pratica, usare una Main API Key è analogo a usare direttamente l’Auth Token dal punto di vista dei permessi (e va protetta allo stesso modo).

Quando crei una API Key dalla Console Twilio, ti verrà chiesto di scegliere il tipo (Standard o Main) e la **region**. Twilio consente infatti di associare la key a una regione geografica (es. **Global** predefinito, o altre regioni per esigenze di residenza dei dati). Dopo la creazione, Twilio ti mostrerà una sola volta la Key Secret (assicurati di copiarla e custodirla subito). Da quel momento in poi, potrai utilizzare la coppia **API Key SID + API Key Secret** al posto di **Account SID + Auth Token** per autenticare le richieste API.

**Esempio di utilizzo delle API Key:** Una volta creata una API Key, ecco come si può usare in pratica nell’autenticazione. Invece di username=Account SID e password=Auth Token, utilizzeremo username=API Key SID e password=API Key Secret. Ad esempio, con il helper Python:

```python
import os
from twilio.rest import Client

# Leggi le credenziali sicure dall'ambiente (evitando hardcoding)
account_sid = os.getenv("TWILIO_ACCOUNT_SID")
api_key_sid = os.getenv("TWILIO_API_KEY_SID")
api_key_secret = os.getenv("TWILIO_API_KEY_SECRET")

# Inizializza il client Twilio con API Key SID/Secret invece di Account SID/Auth Token
client = Client(api_key_sid, api_key_secret, account_sid)

# Esempio di chiamata API: invio di un SMS
message = client.messages.create(
    body="Questo è un messaggio di test",
    from_="+391234567890",  # tuo numero Twilio 
    to="+390987654321"     # numero di destinazione
)
print(f"Messaggio inviato, SID: {message.sid}")
```

Nell’esempio sopra, la libreria Twilio Python viene inizializzata con `Client(api_key_sid, api_key_secret, account_sid)`. Dietro le quinte, il client utilizzerà l’API Key SID come username e la sua Secret come password per le richieste API. Notare che passiamo anche l’Account SID come terzo parametro: questo serve a specificare a quale account fare riferimento (dato che una API Key potrebbe potenzialmente essere associata a più subaccount se generata da un Main key con accesso a essi). Se si omette, il client usa implicitamente l’account corrispondente alla API Key.

**Vantaggi delle API Key:** L’utilizzo delle API Key presenta diversi benefici:
- Puoi generare **più API Key** in contemporanea per uno stesso account. Mentre per l’Auth Token hai al massimo il token primario e (opzionalmente) un secondario in rotazione, con le API Key non c’è un limite stringente al numero di chiavi che puoi avere attive ([Build Better Twilio Authentication with C# API Keys | Twilio](https://www.twilio.com/en-us/blog/better-twilio-authentication-csharp-twilio-api-keys#:~:text=You%20can%20create%20as%20many,they%20are%20no%20longer%20used)). Ciò permette ad esempio di creare una chiave distinta per ogni applicazione, servizio, o sviluppatore che necessita di interagire con Twilio, riducendo la necessità di condividere il singolo Auth Token principale.
- Puoi **revocare** (cancellare) una API Key in qualsiasi momento senza impattare le altre. Se una chiave viene compromessa o non serve più, la elimini e tutte le altre continuano a funzionare. Invece, se dovessi disabilitare l’Auth Token principale senza un secondario pronto, bloccheresti tutte le integrazioni simultaneamente.
- Puoi limitare i privilegi: assegnando solo **Standard API Key** alla maggior parte dei servizi, puoi impedire che quelle chiavi possano essere usate per alterare configurazioni critiche (come creare altre chiavi o subaccount). E, come vedremo dopo, sono in arrivo anche *Restricted API Keys* per limitare ancora più granularmente i permessi.
- Le API Key sono ottimali per l’uso in team: invece di consegnare a un team di sviluppatori l’Auth Token dell’account (che dà pieno potere), puoi generare una API Key dedicata per loro. In questo modo, se un membro del team lascia il progetto o se la chiave finisce esposta, puoi semplicemente revocare quella chiave senza dover effettuare il rotate di tutto l’Auth Token dell’account ([Build Better Twilio Authentication with C# API Keys | Twilio](https://www.twilio.com/en-us/blog/better-twilio-authentication-csharp-twilio-api-keys#:~:text=You%20can%20create%20as%20many,they%20are%20no%20longer%20used)). Twilio stessa raccomanda: *“invece di passare in giro le credenziali dell’account, fornisci API Key separate e revocale quando non servono più”* ([Build Better Twilio Authentication with C# API Keys | Twilio](https://www.twilio.com/en-us/blog/better-twilio-authentication-csharp-twilio-api-keys#:~:text=You%20can%20create%20as%20many,they%20are%20no%20longer%20used)).

### Creazione e gestione delle API Key
Le API Key possono essere create e gestite in tre modi:
- **Tramite Console Twilio:** vai nella sezione **API Keys & Tokens** del Console (sotto Account). Clicca “Create API Key”, assegna un nome descrittivo (ad es. "Chiave per servizio X"), scegli il tipo (Standard o Main) e la regione. Dopo la creazione ti verrà mostrata la Secret una sola volta.
- **Tramite API/SDK:** Twilio fornisce endpoint API (ad es. `POST /2010-04-01/Accounts/{AccountSID}/Keys.json`) e metodi nei propri SDK per creare e gestire le chiavi. **Nota:** per creare una nuova API Key via API, devi autenticarti con credenziali aventi privilegio adeguato, cioè con l’Auth Token dell’account oppure con una Main API Key esistente ([Build Better Twilio Authentication with C# API Keys | Twilio](https://www.twilio.com/en-us/blog/better-twilio-authentication-csharp-twilio-api-keys#:~:text=You%20can%20also%20create%20standard,Key%20to%20manage%20API%20Keys)). Non è possibile creare chiavi aggiuntive usando una chiave di tipo Standard (che appunto non ha permessi sulla gestione delle chiavi).
- **Tramite Twilio CLI:** la CLI Twilio (`twilio` da terminale) offre comandi per creare/eliminare chiavi. Ad esempio, `twilio api:core:keys:create` genera una nuova API Key, mentre `twilio api:core:keys:remove --sid KIXXXX` la rimuove. La CLI può essere utile anche per script di automazione.

Ogni API Key è identificata dal suo SID (prefisso "SK"). Puoi visualizzare tutte le chiavi create (SID e friendly name) dalla Console o via API, e da lì gestirle (es. eliminare quelle non più necessarie). **Importante:** tratta la Key Secret con la stessa segretezza dell’Auth Token; chiunque la possieda insieme al SID potrà effettuare chiamate API a tuo nome. 

## Rotazione delle Credenziali (Token e API Key)
La **rotazione regolare** delle credenziali è una pratica fondamentale per mantenere la sicurezza a lungo termine. Rotazione significa sostituire periodicamente le chiavi/token in uso con nuove chiavi/token, invalidando le vecchie. Ciò limita la finestra temporale in cui eventuali credenziali compromesse possono essere abusate. Di seguito vediamo le strategie di rotazione sia per l’Auth Token dell’account sia per le API Key.

### Rotazione dell’Auth Token dell’Account
Come accennato, Twilio consente di avere un Auth Token secondario per facilitare la rotazione senza downtime. La procedura consigliata per ruotare il token è:
1. **Genera un Secondary Auth Token:** dalla Console Twilio vai in **API Keys & Tokens** e clicca “Generate new Token”. Oppure, via API, esegui una richiesta `POST` all’endpoint apposito (`.../AuthTokens/Secondary`). Otterrai un nuovo token segreto per l’account ([Build Better Twilio Authentication with C# API Keys | Twilio](https://www.twilio.com/en-us/blog/better-twilio-authentication-csharp-twilio-api-keys#:~:text=You%20can%20authenticate%20with%20Twilio%27s,the%20old%20primary%20token%20unusable)).
2. **Aggiorna la tua applicazione:** configura la tua applicazione/server perché utilizzi il nuovo token secondario per autenticarsi (invece del token primario attuale). Assicurati di distribuire questa modifica in tutti gli ambienti che usano Twilio. Idealmente, il token dovrebbe essere referenziato da una variabile d'ambiente o un file di configurazione, rendendo la sostituzione più facile senza cambiare codice.
3. **Promuovi il token secondario a primario:** una volta che sei sicuro che tutte le integrazioni stanno utilizzando il nuovo token, promuovi il Secondary Token a Primary. Questo passaggio invalida il vecchio Auth Token compromesso (che verrà revocato automaticamente da Twilio) ([Build Better Twilio Authentication with C# API Keys | Twilio](https://www.twilio.com/en-us/blog/better-twilio-authentication-csharp-twilio-api-keys#:~:text=You%20can%20authenticate%20with%20Twilio%27s,the%20old%20primary%20token%20unusable)). La promozione può essere fatta dalla Console (cliccando su "Promote Token") o via API con l’endpoint di **promozione**.
4. **Verifica e rimuovi il vecchio token:** assicurati che le tue applicazioni continuino a funzionare correttamente con il nuovo token. Infine, puoi rimuovere (cancellare) il token secondario *se rimasto* oppure rigenerarne un altro secondario per preparare future rotazioni.

Durante la rotazione, Twilio garantisce che entrambi i token (vecchio primario e nuovo secondario/promosso) siano validi per autenticare richieste, fintanto che non promuovi e disabiliti quello obsoleto. **Importante:** se usi Twilio Functions o Servizi Twilio dove l'Auth Token era eventualmente hardcodato, Twilio avvisa di attendere circa 1 minuto dopo la promozione affinché la propagazione del nuovo token sia completa su tutti i sistemi, altrimenti potresti ricevere errori 403 su funzioni invocate nell'immediato ([REST API: Secondary Auth Token | Twilio](https://www.twilio.com/docs/iam/api/secondary_authtoken#:~:text=If%20you%20are%20using%20Services,error)) ([REST API: Secondary Auth Token | Twilio](https://www.twilio.com/docs/iam/api/secondary_authtoken#:~:text=Twilio%20uses%20the%20Account%20SID,two%20related%20endpoints%2C%20one%20to)). Evita comunque di inserire il token direttamente nel codice di funzioni o applicazioni (meglio usare configurazioni) per facilitare questo processo.

Twilio raccomanda inoltre di **cambiare periodicamente i token di autenticazione** anche se non ci sono evidenze di compromissione, come misura di igiene della sicurezza ([Guide to Basic API Security Best Practices | Twilio](https://www.twilio.com/en-us/blog/basic-api-security-guide#:~:text=%2A%20Use%20time,an%20expiration%20to%20the%20tokens)) (ad esempio, potresti programmare una rotazione dell’Auth Token ogni 6 mesi). 

### Rotazione delle API Key
Le API Key, per loro natura, sono più facili da ruotare senza impatto, dal momento che puoi avere più chiavi attive contemporaneamente. Una possibile strategia di rotazione preventiva delle API Key è la seguente:

1. **Crea una nuova API Key:** genera una nuova chiave (Standard) per il tuo account, tramite Console, API o CLI. Annota il nuovo SID e Secret generati ([Build Better Twilio Authentication with C# API Keys | Twilio](https://www.twilio.com/en-us/blog/better-twilio-authentication-csharp-twilio-api-keys#:~:text=,secret)).
2. **Aggiorna le applicazioni per usare la nuova chiave:** proprio come per l’Auth Token, modifica le configurazioni/variabili d’ambiente delle tue applicazioni sostituendo la vecchia API Key SID/Secret con la nuova coppia. Distribuisci queste modifiche.
3. **Testa il funzionamento:** verifica che tutte le integrazioni funzionino correttamente con la nuova chiave (ad esempio inviando un SMS di prova, effettuando chiamate API, etc.).
4. **Revoca la vecchia API Key:** quando sei certo che la vecchia chiave non è più utilizzata da nessun servizio, eliminala (tramite Console o comando API/CLI). Questo invaliderà immediatamente quelle credenziali, impedendo ulteriori abusi in caso fossero state compromesse.

Twilio sottolinea che un grande vantaggio dell’uso delle API Key è proprio la possibilità di **automatizzare la rotazione** programmaticamente. Essendo disponibile un endpoint API per creare ed eliminare chiavi, uno sviluppatore può scrivere script o utilizzare la Twilio CLI per rigenerare chiavi a intervalli regolari e aggiornare le applicazioni di conseguenza ([Build Better Twilio Authentication with C# API Keys | Twilio](https://www.twilio.com/en-us/blog/better-twilio-authentication-csharp-twilio-api-keys#:~:text=Rotate%20API%20Keys)). Ad esempio, uno script di rotazione può creare una nuova chiave, distribuire le nuove credenziali agli servizi (magari tramite un orchestratore o pipeline CI/CD), quindi decommissionare la chiave vecchia ([Build Better Twilio Authentication with C# API Keys | Twilio](https://www.twilio.com/en-us/blog/better-twilio-authentication-csharp-twilio-api-keys#:~:text=One%20of%20the%20advantages%20of,the%20Twilio%20CLI%20and%20PowerShell)). 

> **Best Practice:** Implementa sempre la rotazione in modo **atomico e sicuro**. Assicurati che le nuove credenziali siano ben propagate e attive **prima** di revocare le vecchie, per evitare interruzioni. Testa la procedura in un ambiente di staging. Twilio avverte di verificare attentamente che l’applicazione gestisca la rotazione in modo **graceful** (senza perdere richieste) ([Build Better Twilio Authentication with C# API Keys | Twilio](https://www.twilio.com/en-us/blog/better-twilio-authentication-csharp-twilio-api-keys#:~:text=Note%3A%20Make%20sure%20you%20have,Twilio%20CLI%C2%A0before%20running%20this%20code)).

## Isolamento e Privilegi Limitati: Subaccount e Restricted API Keys
Per migliorare ulteriormente la sicurezza, Twilio offre strumenti per limitare l’ambito di ciò che certe credenziali possono fare o a quale parte dei dati possono accedere. Due approcci principali sono: l’utilizzo di **Subaccount** e le **Restricted API Keys**.

### Subaccount per segmentare l’accesso
I **Subaccount** sono account secondari collegati al tuo account principale Twilio, ciascuno con il proprio SID e Auth Token. Puoi crearli ad esempio per separare ambienti (produzione, staging, sviluppo) o per separare diverse applicazioni/progetti, mantenendo comunque la fatturazione unificata sotto l'account principale. Ogni subaccount ha le sue credenziali e le sue risorse isolate. Dal punto di vista dell'autenticazione API, un subaccount si comporta come un account Twilio a sé: userà il proprio Account SID e Auth Token (o relative API Key) per autenticarsi.

**Vantaggio di sicurezza:** se un Auth Token (o API Key) di un subaccount viene compromesso, l'accesso dell'attaccante è limitato **solo** alle risorse di quel subaccount, e non all’account principale o ad altri subaccount ([Build Better Twilio Authentication with C# API Keys | Twilio](https://www.twilio.com/en-us/blog/better-twilio-authentication-csharp-twilio-api-keys#:~:text=primary%20token%20unusable)). Questo contiene enormemente i danni potenziali. Twilio stessa suggerisce di **segmentare gli accessi tramite subaccount** per proteggere le credenziali: *“Puoi proteggere le tue credenziali segmentando il tuo account con subaccount. Se un auth token o una API Key per un subaccount è compromesso, quel token può essere usato solo per accedere alle risorse di quel subaccount.”* ([Build Better Twilio Authentication with C# API Keys | Twilio](https://www.twilio.com/en-us/blog/better-twilio-authentication-csharp-twilio-api-keys#:~:text=primary%20token%20unusable)). Ad esempio, potresti creare un subaccount dedicato per un particolare cliente o per un particolare servizio; in caso di violazione delle chiavi di quel subaccount, gli altri clienti/servizi rimangono al sicuro.

Per usare un subaccount nelle API, dovrai specificare l’Account SID del subaccount e il relativo Auth Token/API Key. Spesso, quando crei una API Key tramite l’account principale, puoi scegliere di associarla a uno specifico subaccount come **scopo**. Ricorda che le credenziali di un subaccount non possono agire al di fuori di esso; inoltre, l’account principale può sempre accedere ai dati di tutti i subaccount (quindi custodisci con attenzione anche le credenziali del master account). 

### Restricted API Keys (chiavi API a privilegio limitato)
Una novità nel sistema di autenticazione Twilio è l’introduzione delle **Restricted API Keys** (attualmente in Beta pubblica) ([Restricted API Keys | Twilio](https://www.twilio.com/docs/iam/api-keys/restricted-api-keys#:~:text=Public%20Beta%20Notice)) ([Restricted API Keys | Twilio](https://www.twilio.com/docs/iam/api-keys/restricted-api-keys#:~:text=Restricted%20API%20Keys%20allow%20you,Keys%20using%20%2013%20REST)). A differenza delle API Key Standard/Main, che ereditano per intero i permessi di un account (principali o quasi totali, come visto sopra), le Restricted API Keys consentono di specificare in modo granulare **quali risorse API e azioni** sono permesse con quella chiave ([Restricted API Keys | Twilio](https://www.twilio.com/docs/iam/api-keys/restricted-api-keys#:~:text=Restricted%20API%20Keys%20allow%20you,Keys%20using%20%2013%20REST)). In sostanza, applicano il principio del **least privilege** (minimo privilegio necessario): puoi creare una chiave che, ad esempio, ha permesso solo di inviare SMS (`/Messages` resource in API) e niente altro, oppure solo di leggere i log delle chiamate ma non di effettuarne.

Alcuni possibili utilizzi di Restricted API Keys:
- Creare una chiave che possa **solo inviare messaggi SMS/MMS** e non effettuare chiamate vocali né modificare configurazioni. Se quella chiave venisse rubata, il danno sarebbe limitato solo alla possibilità di inviare SMS (e potresti eventualmente riconoscere attività anomale su quel fronte).
- Generare una chiave con permesso **sola lettura** su certi dati (ad esempio solo leggere i record di costo o gli Usage Records, senza poter inviare/transmettere nulla).
- Assegnare una chiave molto limitata a un servizio terzo o a un contractor, sapendo che con quella non potrà eccedere l’ambito stabilito.

Attualmente (febbraio 2025), le Restricted API Keys sono in beta, quindi potrebbero avere limitazioni e non coprire tutti i prodotti Twilio. La creazione e gestione avviene via API o tramite la Twilio Console (quando abilitata). Puoi definire una lista di **permessi** per chiave, scegliendo fra le varie risorse (Messaggi, Chiamate, Chat, Email, etc.) e le azioni consentite (LEGGI, SCRIVI, ELIMINA...). La documentazione Twilio fornisce l’elenco completo dei permessi disponibili ([Restricted API Keys | Twilio](https://www.twilio.com/docs/iam/api-keys/restricted-api-keys#:~:text=Restricted%20API%20Keys%20allow%20you,Keys%20using%20%2013%20REST)) ([Restricted API Keys | Twilio](https://www.twilio.com/docs/iam/api-keys/restricted-api-keys#:~:text=,45)).

Twilio consiglia vivamente, quando possibile, di **limitare l’ambito delle API Key** che utilizzi ([Guide to Basic API Security Best Practices | Twilio](https://www.twilio.com/en-us/blog/basic-api-security-guide#:~:text=,senders%2C%20and%20verifying%20message%20content)). Come indicato nelle best practice: *“Non rendere le tue API Key altamente privilegiate, per evitare di fornire accesso a tutto il tuo account se la chiave viene compromessa”* ([Guide to Basic API Security Best Practices | Twilio](https://www.twilio.com/en-us/blog/basic-api-security-guide#:~:text=,senders%2C%20and%20verifying%20message%20content)). In futuro, con la disponibilità generale delle Restricted API Keys, sarà opportuno utilizzarle per implementare questo principio. Nel frattempo, l’uso combinato di subaccount e chiavi standard può già aiutare a segmentare privilegi.

## Access Token (JWT) per i client Twilio (SDK lato client)
Finora abbiamo parlato dell’autenticazione per le richieste server-to-server (il tuo server che chiama le API Twilio). Twilio però offre anche diversi SDK **client-side** (lato utente, es. in applicazioni mobile o web) come *Twilio Voice SDK*, *Programmable Video*, *Conversations (Chat)*, *Sync*, ecc. Chiaramente **non è sicuro** incorporare un Auth Token o una API Key Secret direttamente in un’applicazione client (che verrebbe distribuita agli utenti), perché sarebbe esposta e sfruttabile da chiunque. Per questi casi, Twilio utilizza un meccanismo di autenticazione tramite **Access Token**, che sono token di accesso temporanei basati su JSON Web Token (JWT).

**Cosa sono gli Access Token:** Gli Access Token Twilio sono token firmati dal tuo server che attestano l’identità di un utente o device cliente e gli concedono il permesso di usare certi servizi Twilio per un periodo limitato. Tecnicamente, un Access Token include il SID del tuo account, un SID di API Key e viene **firmato con la API Key Secret** corrispondente, includendo al suo interno una serie di *grant* (autorizzazioni) che specificano a quali servizi Twilio l’utente può accedere e con quali privilegi. Ogni token ha inoltre una scadenza breve (per default solitamente 1 ora, configurabile fino a qualche ora).

**Uso tipico:** Supponiamo tu stia costruendo un’app di videochiamata con Twilio Programmable Video. Il flusso sarà:
- Sul tuo server (protetto), generi una API Key Twilio che userai per firmare i token.
- Quando un utente fa login o richiede di entrare in una stanza video, il tuo server crea un Access Token JWT contenente: l’ID dell’utente (identity), un grant per *Programmable Video* (che autorizza l’accesso a una specifica Video Room, magari), e una durata di validità (es. 1 ora). Firma questo token con la tua API Key Secret.
- Il token viene inviato al client (app mobile/web) dell’utente.
- Il client include questo token quando inizializza l’SDK Twilio Video. L’SDK lo invierà a Twilio per autenticare la sessione.
- Twilio verifica la firma e le informazioni del token: se valido e non scaduto, permette al client di interagire solo con le risorse consentite da quel token (in questo caso la stanza video specifica).
- Dopo la scadenza (o se l’utente prova ad usare il token per altre risorse non consentite), l’accesso viene negato. L’app dovrà richiedere un nuovo token al server se necessario.

Questo meccanismo assicura che le *credenziali master* (Auth Token o API Secret) **non vengano mai esposte lato client**. Anche se qualcuno intercettasse un Access Token, avrebbe un accesso limitato e temporaneo. Twilio enfatizza l’importanza di usare **token a tempo** (time-based tokens) proprio per i casi d’uso client: *“Usa token di accesso temporanei basati sul tempo”* ([Guide to Basic API Security Best Practices | Twilio](https://www.twilio.com/en-us/blog/basic-api-security-guide#:~:text=,an%20expiration%20to%20the%20tokens)) invece di condividere credenziali permanenti. Gli Access Token implementano esattamente questo concetto.

Per generare Access Token in modo corretto, Twilio fornisce librerie server-side (ad esempio `twilio.jwt` in Python, o classi AccessToken in altre SDK) che facilitano la creazione del JWT con i grant appropriati. Assicurati di impostare un TTL (time-to-live) ragionevole e di limitarne i privilegi ai soli necessari (ad esempio, un token per chat non dovrebbe includere anche permessi per effettuare chiamate voce, se non serve).

## Best Practice di Sicurezza e Gestione delle Chiavi
In questa sezione riepiloghiamo le migliori pratiche da seguire per gestire in sicurezza le credenziali Twilio (Auth Token, API Key e affini) e prevenire accessi non autorizzati. Molti di questi punti derivano dalle linee guida ufficiali Twilio ([Guide to Basic API Security Best Practices | Twilio](https://www.twilio.com/en-us/blog/basic-api-security-guide#:~:text=,an%20expiration%20to%20the%20tokens)) ([Guide to Basic API Security Best Practices | Twilio](https://www.twilio.com/en-us/blog/basic-api-security-guide#:~:text=,by%20using%20IP%20access%20management)) ([Guide to Basic API Security Best Practices | Twilio](https://www.twilio.com/en-us/blog/basic-api-security-guide#:~:text=,based%20access%20tokens)).

- **Non condividere né esporre le tue credenziali sensibili:** evita di fornire il tuo Account SID e soprattutto l’Auth Token a persone o dispositivi non strettamente necessari. Ogni volta che le credenziali vengono divulgate, aumenta il rischio che possano essere compromesse ([Build Better Twilio Authentication with C# API Keys | Twilio](https://www.twilio.com/en-us/blog/better-twilio-authentication-csharp-twilio-api-keys#:~:text=These%20credentials%20are%20frequently%20used,the%20leaked%20token%20becomes%20useless)). In particolare, **non pubblicare mai** l’Auth Token (o le API Key Secret) su repository pubblici, forum, messaggi, ecc. Twilio ha integrato un sistema chiamato **GitHub Token Scanning** che invia una notifica email di sicurezza se rileva che Account SID e Auth Token sono stati commitatti su un repository pubblico GitHub ([Twilio Git Guard Credential Leak Alerts | Twilio](https://www.twilio.com/en-us/changelog/twilio-git-guard-credential-leak-alerts#:~:text=Twilio%20Git%20Guard%20Credential%20Leak,Alerts)). Affidati a questi alert solo come rete di sicurezza ultima; la prima difesa deve essere la prudenza nel non esporre le chiavi.
- **Non hardcodare le credenziali nel codice sorgente:** invece di scrivere direttamente i token o le API Key nel codice dell’applicazione, con il rischio che finiscano nel controllo versione, usa metodi più sicuri di configurazione. Ad esempio, imposta le credenziali come **variabili d’ambiente** sul server o utilizza file di configurazione separati (ad es. un file `.env` non incluso nel VCS) ([Guide to Basic API Security Best Practices | Twilio](https://www.twilio.com/en-us/blog/basic-api-security-guide#:~:text=,by%20using%20IP%20access%20management)). In questo modo, anche se condividi il codice, le credenziali rimangono separate. Twilio raccomanda esplicitamente di **non lasciare token o API Key nel codice o in applicazioni distribuite**, ma di **stoccarli in luoghi sicuri e controllati** (ad esempio servizi di secret management, vault, ecc.) ([Guide to Basic API Security Best Practices | Twilio](https://www.twilio.com/en-us/blog/basic-api-security-guide#:~:text=,an%20expiration%20to%20the%20tokens)) ([Guide to Basic API Security Best Practices | Twilio](https://www.twilio.com/en-us/blog/basic-api-security-guide#:~:text=,by%20using%20IP%20access%20management)).
- **Proteggi l’accesso alla Twilio Console:** utilizza password robuste e uniche per il tuo account Twilio, e abilita sempre l’**autenticazione a più fattori (MFA)** sul login della Console ([Guide to Basic API Security Best Practices | Twilio](https://www.twilio.com/en-us/blog/basic-api-security-guide#:~:text=,based%20access%20tokens)). In questo modo, anche se qualcuno ottenesse la tua password, non potrebbe accedere senza il secondo fattore. Se possibile, integra con **Single Sign-On (SSO)** aziendale per un ulteriore livello di sicurezza e comodità ([Guide to Basic API Security Best Practices | Twilio](https://www.twilio.com/en-us/blog/basic-api-security-guide#:~:text=,based%20access%20tokens)).
- **Usa le API Key al posto dell’Auth Token quando sviluppi applicazioni:** per tutte le ragioni discusse, preferisci creare API Key specifiche per le tue applicazioni invece di utilizzare l’Auth Token principale. In caso di compromissione o necessità di revoca, l’impatto sarà minore ([Build Better Twilio Authentication with C# API Keys | Twilio](https://www.twilio.com/en-us/blog/better-twilio-authentication-csharp-twilio-api-keys#:~:text=API%20Keys%20are%20now%20the,compromised%20or%20no%20longer%20used)). Idealmente, tieni l’Auth Token principale quasi “in cassaforte” e usalo solo per operazioni amministrative (come creare le API Key stesse o consultare la Console).
- **Isola diversi contesti con Subaccount:** se gestisci più progetti, ambienti o clienti, valuta di usare subaccount separati. In questo modo le credenziali (token/API Key) di ciascun subaccount danno accesso solo a una porzione dei dati Twilio. Come visto, un leak su un subaccount non comprometterà l’intera operatività ([Build Better Twilio Authentication with C# API Keys | Twilio](https://www.twilio.com/en-us/blog/better-twilio-authentication-csharp-twilio-api-keys#:~:text=primary%20token%20unusable)). Organizza i subaccount in base alle tue esigenze (ad esempio uno per ambiente dev, uno per prod, oppure per ciascun cliente nel caso di un’app multi-tenant).
- **Limita i privilegi delle chiavi (principio del minimo privilegio):** non dare a una chiave più permessi del necessario. Attualmente, puoi ottenere ciò in parte utilizzando *Standard API Key* invece di *Main* per la maggior parte dei casi (così le chiavi non possono creare altre chiavi o subaccount). In prospettiva, adotta le **Restricted API Keys** per definire esattamente cosa ogni chiave può fare ([Guide to Basic API Security Best Practices | Twilio](https://www.twilio.com/en-us/blog/basic-api-security-guide#:~:text=,senders%2C%20and%20verifying%20message%20content)). Ad esempio, per un microservizio che invia solo SMS, crea una chiave che abbia permessi solo sui messaggi. Ciò riduce drasticamente il potenziale abuso in caso di furto di quella chiave.
- **Ruota periodicamente le credenziali:** stabilisci un calendario di rotazione per Auth Token e API Key. Ad esempio, potresti rigenerare nuove API Key ogni tot mesi e deprecare le vecchie, o utilizzare sempre token secondari per poi promuoverli periodicamente ([Guide to Basic API Security Best Practices | Twilio](https://www.twilio.com/en-us/blog/basic-api-security-guide#:~:text=%2A%20Use%20time,an%20expiration%20to%20the%20tokens)). La rotazione regolare limita i danni di eventuali compromissioni silenti (di cui potresti non essere a conoscenza) e impone una “data di scadenza” alle credenziali. Ricorda di aggiornare tutta la documentazione interna e le configurazioni ogni volta che ruoti, per non perdere traccia.
- **Monitora l’attività e abilita alert:** sfrutta gli strumenti di monitoring offerti da Twilio, come il **Monitor API** (che può segnalare attività sospette) e configura **Usage Triggers** o altri allarmi per consumi anomali. Twilio offre ad esempio la possibilità di impostare trigger su certi eventi o soglie di spesa. Inoltre, puoi registrarti per ricevere notifiche in caso di modifiche alle credenziali stesse. Un esempio è il succitato **Git Guard** per i leak su GitHub ([Twilio Git Guard Credential Leak Alerts | Twilio](https://www.twilio.com/en-us/changelog/twilio-git-guard-credential-leak-alerts#:~:text=Twilio%20Git%20Guard%20Credential%20Leak,Alerts)). Essere proattivi nel rilevare possibili compromissioni ti permette di reagire più velocemente.
- **Valida le richieste in ingresso da Twilio:** anche se non riguarda l’autenticazione *verso* Twilio, ma piuttosto quella *da* Twilio, è rilevante menzionare che dovresti sempre verificare che le chiamate o webhook che ricevi (es. callback SMS, webhook Voice, ecc.) siano veramente inviati da Twilio. Twilio firma le richieste con un header `X-Twilio-Signature` che puoi validare usando il tuo Auth Token come chiave, oppure Twilio offre un meccanismo di **Public Key Client Validation (PKCV)** per validare le richieste in modo ancora più robusto senza condividere segreti ([Guide to Basic API Security Best Practices | Twilio](https://www.twilio.com/en-us/blog/basic-api-security-guide#:~:text=,senders%2C%20and%20verifying%20message%20content)). Implementare questa verifica assicura che un malintenzionato non possa falsificare richieste verso la tua applicazione spacciandosi per Twilio. Le librerie Twilio Helpers spesso includono funzioni per fare questa validazione facilmente ([Guide to Basic API Security Best Practices | Twilio](https://www.twilio.com/en-us/blog/basic-api-security-guide#:~:text=3)).
- **Mantieniti aggiornato sulle pratiche di sicurezza:** la piattaforma Twilio evolve e così anche le sue raccomandazioni. Consulta periodicamente la documentazione di sicurezza Twilio ([REST API: Credentials | Twilio](https://www.twilio.com/docs/iam/credentials/api#:~:text=HTTP%20requests%20to%20the%20REST,password%20for%20HTTP%20Basic%20authentication)) e il **Trust Center** di Twilio per novità su autenticazione, nuove feature (come le Restricted API Keys) e obblighi (ad esempio, Twilio può richiedere l’uso del 2FA sulla Console). Segui anche il blog Twilio per articoli tecnici e best practice aggiornate.

Seguendo queste linee guida, potrai autenticarti alle API Twilio in modo sicuro e gestire le chiavi e token minimizzando i rischi per la tua applicazione e i dati dei tuoi utenti. La sicurezza è un processo continuo: integra queste best practice nel tuo ciclo di sviluppo e operazioni (DevOps) in modo che la gestione delle credenziali Twilio sia automatizzata, verificata e conforme alle policy della tua organizzazione.

